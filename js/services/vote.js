function getVoteKey(t){return`vote-${t}`}function hasVoted(t){return!!localStorage.getItem(getVoteKey(t))}function getVotedValue(t){return localStorage.getItem(getVoteKey(t))}function storeVote(t,e){localStorage.setItem(getVoteKey(t),e)}function removeVote(t){localStorage.removeItem(getVoteKey(t))}function markVoted(t,e){t.classList.add("voted"),"up"===e?t.querySelector(".vote-up")?.classList.add("active"):"down"===e&&t.querySelector(".vote-down")?.classList.add("active")}function revertVote(t,e){const o=t.dataset.id;if("up"===e){const e=t.querySelector(".up");e&&(e.textContent=Math.max(0,parseInt(e.textContent||"1")-1))}else if("down"===e){const e=t.querySelector(".down");e&&(e.textContent=Math.max(0,parseInt(e.textContent||"1")-1))}t.classList.remove("voted","active"),t.querySelector(".vote-up")?.classList.remove("active"),t.querySelector(".vote-down")?.classList.remove("active"),removeVote(o)}async function loadVote(t){const e=t.dataset.id,o=t.dataset.api;if(e&&o)try{const n=await fetch(`${o}/info?id=${encodeURIComponent(e)}`),a=await n.json();t.querySelector(".up").textContent=a.votes?.up??0,t.querySelector(".down").textContent=a.votes?.down??0}catch(t){console.warn(`[vote] 加载失败: id=${e}`,t)}}function submitVote(t,e){const o=t.dataset.id,n=t.dataset.api;if(!o||!n||hasVoted(o))return;const a=t.querySelector(".up"),c=t.querySelector(".down");"up"===e&&a&&(a.textContent=parseInt(a.textContent||"0")+1),"down"===e&&c&&(c.textContent=parseInt(c.textContent||"0")+1),storeVote(o,e),markVoted(t,e),fetch(`${n}/update?id=${encodeURIComponent(o)}&value=${encodeURIComponent(e)}`,{method:"POST"}).catch(n=>{console.warn(`[vote] 后台同步失败，撤销投票: id=${o}`,n),revertVote(t,e)})}function initVotes(){document.querySelectorAll(".ds-vote").forEach(t=>{const{id:e,api:o}=t.dataset;if(!e||!o)return;loadVote(t);const n=getVotedValue(e);n&&markVoted(t,n),t.querySelector(".vote-up")?.addEventListener("click",()=>{t.classList.contains("active")||submitVote(t,"up")}),t.querySelector(".vote-down")?.addEventListener("click",()=>{t.classList.contains("active")||submitVote(t,"down")})})}"loading"===document.readyState?window.addEventListener("DOMContentLoaded",initVotes):initVotes();