function getRatingKey(e){return`rating-${e}`}function hasRated(e){return!!localStorage.getItem(getRatingKey(e))}function getRatedValue(e){return parseInt(localStorage.getItem(getRatingKey(e))||"0")}function storeRating(e,t){localStorage.setItem(getRatingKey(e),t)}function clearHover(e){e.querySelectorAll(".star").forEach(e=>e.classList.remove("hover"))}function updatePreview(e,t){const a=Math.floor(t);e.querySelectorAll(".star").forEach(e=>{const t=parseInt(e.dataset.value);e.classList.toggle("preview",t<=a)})}function setupHoverEffect(e){const t=e.querySelectorAll(".star");t.length&&t.forEach(a=>{const n=parseInt(a.dataset.value);a.addEventListener("mouseenter",()=>{t.forEach(e=>{e.classList.remove("preview");const t=parseInt(e.dataset.value);e.classList.toggle("hover",t<=n)})}),a.addEventListener("mouseleave",()=>{clearHover(e);const t=parseFloat(e.querySelector(".avg")?.textContent.replace(/[()]/g,"")||"0");updatePreview(e,t)})})}function calculateAverage(e={}){const t=Object.entries(e).filter(([e])=>!isNaN(Number(e))),a=t.reduce((e,[t,a])=>e+Number(t)*a,0),n=t.reduce((e,[,t])=>e+t,0);return n>0?(a/n).toFixed(1):"0.0"}async function loadRating(e){const t=e.dataset.id,a=e.dataset.api;if(t&&a)try{const n=await fetch(`${a}/info?id=${encodeURIComponent(t)}`),r=(await n.json()).rating||{},o=calculateAverage(r),c=Object.entries(r).filter(([e])=>!isNaN(Number(e))).reduce((e,[,t])=>e+t,0);let s=e.querySelector(".avg");s||(s=document.createElement("span"),s.className="avg",e.appendChild(s)),s.textContent=`(${o})`;let i=e.querySelector(".count");i||(i=document.createElement("span"),i.className="count",e.appendChild(i)),i.textContent=`${c}`,updatePreview(e,o)}catch(e){console.warn(`[rating] 加载失败: id=${t}`,e)}}async function submitRating(e,t){const a=e.dataset.id,n=e.dataset.api;if(a&&n&&!hasRated(a)){storeRating(a,t),e.classList.add("rated");try{await fetch(`${n}/update?id=${encodeURIComponent(a)}&value=${t}`,{method:"POST"}),loadRating(e)}catch(e){console.warn(`[rating] 提交失败: id=${a}`,e)}}}function initRatings(){document.querySelectorAll(".ds-rating").forEach(e=>{const{id:t,api:a}=e.dataset;t&&a&&(loadRating(e),setupHoverEffect(e),hasRated(t)&&e.classList.add("rated"),e.querySelectorAll(".star").forEach(a=>{const n=a.dataset.value;a.addEventListener("click",()=>{hasRated(t)||submitRating(e,n)})}))})}"loading"===document.readyState?window.addEventListener("DOMContentLoaded",initRatings):initRatings();